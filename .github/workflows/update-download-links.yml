name: Update Download Links

on:
  release:
    types: [published]

jobs:
  update-links:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Download latest.yml from release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release download ${{ github.event.release.tag_name }} -p "latest.yml"

      - name: Parse path from latest.yml
        id: parse
        run: |
          ASSET_PATH=$(grep "^path:" latest.yml | cut -d' ' -f2)
          echo "asset_path=$ASSET_PATH" >> $GITHUB_OUTPUT
          echo "Found asset path: $ASSET_PATH"

      - name: Build download URL
        id: build_url
        run: |
          REPO="${{ github.repository }}"
          TAG="${{ github.event.release.tag_name }}"
          ASSET_PATH="${{ steps.parse.outputs.asset_path }}"
          DOWNLOAD_URL="https://github.com/${REPO}/releases/download/${TAG}/${ASSET_PATH}"
          echo "download_url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT
          echo "Built download URL: $DOWNLOAD_URL"

      - name: Update index.html
        run: |
          DOWNLOAD_URL="${{ steps.build_url.outputs.download_url }}"
          sed -i "s|href=\"[^\"]*\.exe\"|href=\"$DOWNLOAD_URL\"|g" index.html
          echo "Updated index.html with new download URL"

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add index.html
          git commit -m "Update download links for release ${{ github.event.release.tag_name }}"
          git push
